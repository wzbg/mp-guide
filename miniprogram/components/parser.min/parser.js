// 小程序富文本插件 https://github.com/jin-yufeng/Parser
var dom;function t(t){for(var e=t.length,i=5381;e--;)i+=(i<<5)+t.charCodeAt(e);return i}var e={},i=require("./libs/MpHtmlParser.js"),n=wx.getFileSystemManager&&wx.getFileSystemManager();Component({options:{pureDataPattern:/^[acdgtu]|W/},properties:{html:{type:null,observer:function(t){this._refresh?this._refresh=!1:this.setContent(t,!1,!0)}},autopause:{type:Boolean,value:!0},autoscroll:Boolean,autosetTitle:{type:Boolean,value:!0},compress:Number,domain:String,lazyLoad:Boolean,loadingImg:String,selectable:Boolean,tagStyle:Object,showWithAnimation:Boolean,useAnchor:Boolean,useCache:Boolean},relations:{"../parser-group/parser-group":{type:"ancestor"}},created:function(){this.imgList=[],this.imgList.setItem=function(t,e){var i=this;if(t&&e){if(0==e.indexOf("http")&&this.includes(e)){for(var o,r="",a=0;(o=e[a])&&("/"!=o||"/"==e[a-1]||"/"==e[a+1]);a++)r+=Math.random()>.5?o.toUpperCase():o;return r+=e.substr(a),this[t]=r}if(this[t]=e,e.includes("data:image")){var s=e.match(/data:image\/(\S+?);(\S+?),(.+)/);if(!s)return;var l=wx.env.USER_DATA_PATH+"/"+Date.now()+"."+s[1];n&&n.writeFile({filePath:l,data:s[3],encoding:s[2],success:function(){return i[t]=l}})}}},this.imgList.each=function(t){for(var e=0,i=this.length;e<i;e++)this.setItem(e,t(this[e],e,this))},dom&&(this.document=new dom(this))},detached:function(){this.imgList.each(function(t){t&&t.includes(wx.env.USER_DATA_PATH)&&n&&n.unlink({filePath:t})}),clearInterval(this._timer)},methods:{navigateTo:function(t){var e=this;if(!this.data.useAnchor)return t.fail&&t.fail({errMsg:"Anchor is disabled"});this.createSelectorQuery().select(".top"+(t.id?">>>#"+t.id:"")).boundingClientRect().selectViewport().scrollOffset().exec(function(i){if(!i[0])return e.group?e.group.navigateTo(e.i,t):t.fail&&t.fail({errMsg:"Label not found"});t.scrollTop=i[1].scrollTop+i[0].top+(t.offset||0),wx.pageScrollTo(t)})},getText:function(){for(var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.data.html,i="",n=0;t=e[n++];)if("text"==t.type)i+=t.text.replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&");else if("br"==t.type)i+="\n";else{var o="p"==t.name||"div"==t.name||"tr"==t.name||"li"==t.name||"h"==t.name[0]&&t.name[1]>"0"&&t.name[1]<"7";o&&i&&"\n"!=i[i.length-1]&&(i+="\n"),t.children&&(i+=this.getText(t.children)),o&&"\n"!=i[i.length-1]?i+="\n":"td"!=t.name&&"th"!=t.name||(i+="\t")}return i},getVideoContext:function(t){if(!t)return this.videoContexts;for(var e=this.videoContexts.length;e--;)if(this.videoContexts[e].id==t)return this.videoContexts[e]},setContent:function(n,o,r){var a=this,s={};if(n)if("string"==typeof n){var l=new i(n,this.data);if(this.data.useCache){var h=t(n);e[h]?s.html=e[h]:(s.html=l.parse(),e[h]=s.html)}else s.html=l.parse();this._refresh=!0,this.triggerEvent("parse",s.html)}else if(n.constructor==Array){if(n.length&&"Parser"!=n[0].PoweredBy){var c=new i("",this.data);!function t(e){for(var i,n=0;i=e[n];n++)if("text"!=i.type){i.attrs=i.attrs||{};for(var o in i.attrs)"string"!=typeof i.attrs[o]&&(i.attrs[o]=i.attrs[o].toString());c.matchAttr(i),i.children&&(c.STACK.push(i),t(i.children),c.popNode(c.STACK.pop()))}}(n),s.html=n}r||(s.html=n)}else{if("object"!=(void 0===n?"undefined":typeof n)||!n.nodes)return console.warn("错误的 html 类型："+(void 0===n?"undefined":typeof n));s.html=n.nodes,console.warn("错误的 html 类型：object 类型已废弃")}else{if(r||o)return;s.html=""}o?(this._refresh=!0,s.html=(this.data.html||[]).concat(s.html)):this.data.showWithAnimation&&(s.showAm="animation: show .5s"),(s.html||s.showAm)&&this.setData(s),this.data.html.length&&this.data.html[0].title&&this.data.autosetTitle&&wx.setNavigationBarTitle({title:this.data.html[0].title}),this.imgList.length=0,this.videoContexts=[];for(var m,f=this.selectAllComponents(".top,.top>>>._node"),d=0;m=f[d++];){m.top=this;for(var u,p=0;u=m.data.nodes[p++];)if(!u.c)if("img"==u.name)this.imgList.setItem(u.attrs.i,u.attrs.src);else if("video"==u.name||"audio"==u.name){var g;g="video"==u.name?wx.createVideoContext(u.attrs.id,m):m.selectComponent("#"+u.attrs.id),g&&(g.id=u.attrs.id,this.videoContexts.push(g))}}(wx.nextTick||setTimeout)(function(){return a.triggerEvent("load")},50);var v;clearInterval(this._timer),this._timer=setInterval(function(){a.createSelectorQuery().select(".top").boundingClientRect(function(t){t&&(a.rect=t,t.height==v&&(a.triggerEvent("ready",t),clearInterval(a._timer)),v=t.height)}).exec()},350)}}})